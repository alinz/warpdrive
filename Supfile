# Warpdrive
---
version: 0.3

env:
  NAME: warpdrive
  IMAGE: warpdrive
  REPO: git@github.com:pressly/warpdrive.git
  BRANCH: master
  WORKDIR: /opt/warpdrive
  DATADIR: /data/warpdrive
  CONFIG: /data/etc/warpdrive.conf
  HOST_PORT: 8221
  CONTAINER_PORT: 8221
  BUILDER_IMAGE: golang:1.6

networks:
  local:
    hosts:
      - localhost
  production:
    hosts:
      - localhost

commands:
  #config:
  #  desc: Upload/test config file.
  #  upload:
  #    - src: etc/warpdrive.$SUP_NETWORK.conf
  #      dst: /tmp/
  #  run: >
  #    test -f /tmp/etc/warpdrive.$SUP_NETWORK.conf || exit 1 && \
  #      sudo mkdir -p $(dirname $CONFIG) && \
  #      sudo mv /tmp/etc/warpdrive.$SUP_NETWORK.conf $CONFIG

  ping:
    desc: Print uname and current date/time.
    run: uname -a; date

  ps:
    desc: List running Docker containers
    run: sudo docker ps | grep $NAME

  pull:
    desc: Pull latest Docker image
    run: sudo docker pull $IMAGE

  # TODO: Move to builder/Supfile?
  build:
    desc: Build Docker image
    script: ./scripts/docker-build.sh
    once: true

  images:
    desc: List Docker image
    run: sudo docker images $IMAGE

  run:
    desc: Run Docker container
    run: >
      sudo docker run -d \
        -p $HOST_PORT:$CONTAINER_PORT \
        -v $DATADIR:/data
        -v $CONFIG:/etc/warpdrive.conf \
        --restart=always \
        --memory-swappiness=0 \
        --log-driver json-file \
        --log-opt max-size=100m \
        --log-opt max-file=5 \
        --name $NAME $IMAGE warpdrive -config=/etc/warpdrive.conf

  logs:
    desc: Docker logs
    run: sudo docker logs $NAME

  tail-logs:
    desc: Tail service logs
    run: sudo docker logs --tail=20 -f $NAME 2>&1

  health:
    desc: Application health check
    run: curl localhost:$HOST_PORT/ping

  stop:
    desc: Stop Docker container
    run: sudo docker stop $NAME || exit 0

  start:
    desc: Start a stopped Docker container
    run: sudo docker start $NAME || exit 0

  restart:
    desc: Restart Docker container
    run: sudo docker restart $NAME || exit 0

  rm:
    desc: Remove Docker container
    run: sudo docker rm $NAME || exit 0

  stop-rm-run:
    desc: Rolling update (stop & remove old Docker container, run new one)
    run: >
      sudo docker stop $NAME || :; \
        sudo docker rm $NAME || :; \
        sudo docker run -d \
          -p $HOST_PORT:$CONTAINER_PORT \
          -v $DATADIR:/data \
          -v $CONFIG:/etc/warpdrive.conf \
          --restart=always \
          --memory-swappiness=0 \
          --log-driver json-file \
          --log-opt max-size=100m \
          --log-opt max-file=5 \
          --name $NAME $IMAGE warpdrive -config=/etc/warpdrive.conf
    serial: 1

  exec:
    desc: Exec into Docker container
    stdin: true
    run: sudo docker exec -i $NAME bash

  shell:
    desc: Interactive shell on all hosts
    stdin: true
    run: /bin/sh

targets:
  deploy:
    - build
    - pull
    #- config
    - stop-rm-run
    - ps
    - logs
    - health
